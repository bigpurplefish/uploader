{%- assign recipient_feature_active = false -%}

{%- if product.gift_card? and block.settings.show_gift_card_recipient -%}
  {%- assign recipient_feature_active = true -%}
{%- endif -%}

{%- comment -%}
CUSTOM: Check if online price should be hidden via metafield
If custom.hide_online_price is true, show call-for-quote CTA instead of buy button
{%- endcomment -%}
{%- assign hide_online_price = product.metafields.custom.hide_online_price | default: false -%}

<div class="product-form__buy-buttons" {{ block.shopify_attributes }}>
  {%- if recipient_feature_active -%}
    <gift-card-recipient class="gift-card-recipient">
      <div class="form__input-wrapper form__input-wrapper--labelled">
        <div class="checkbox-wrapper">
          <input type="checkbox" class="checkbox" name="properties[__shopify_send_gift_card_to_recipient]" id="product-{{ section.id }}-{{ product.id }}-send-gift-card-to-recipient">
          {% render 'icon', icon: 'check' %}
        </div>

        <label for="product-{{ section.id }}-{{ product.id }}-send-gift-card-to-recipient">{{ 'gift_card.recipient.checkbox' | t }}</label>
      </div>

      <div class="gift-card-recipient__fields js:hidden">
        <div class="form__input-wrapper form__input-wrapper--labelled">
          <input id="product-{{ section.id }}-{{ product.id }}-recipient-email" type="email" class="form__field form__field--text" name="properties[Recipient email]" maxlength="138" required value="{{ form.email }}">
          <label for="product-{{ section.id }}-{{ product.id }}-recipient-email" class="form__floating-label">{{ 'gift_card.recipient.email_label' | t }}</label>
        </div>

        <div class="form__input-wrapper form__input-wrapper--labelled">
          <input id="product-{{ section.id }}-{{ product.id }}-recipient-name" type="text" class="form__field form__field--text" name="properties[Recipient name]" value="{{ form.name }}">
          <label for="product-{{ section.id }}-{{ product.id }}-recipient-name" class="form__floating-label">{{ 'gift_card.recipient.name_label' | t }}</label>
        </div>

        <div class="form__input-wrapper form__input-wrapper--labelled">
          <input type="hidden" name="properties[__shopify_offset]" value="" disabled>
          <input id="product-{{ section.id }}-{{ product.id }}-send-on" type="date" class="form__field form__field--date is-filled" pattern="\d{4}-\d{2}-\d{2}" name="properties[Send on]" value="{{ form.send_on }}">
          <label for="product-{{ section.id }}-{{ product.id }}-send-on" class="form__floating-label">{{ 'gift_card.recipient.send_on_label' | t }}</label>
        </div>

        <div class="form__input-wrapper form__input-wrapper--labelled">
          <textarea id="product-{{ section.id }}-{{ product.id }}-recipient-message" rows="4" maxlength="200" class="form__field form__field--textarea" name="properties[Message]">{{ form.message }}</textarea>
          <label for="product-{{ section.id }}-{{ product.id }}-recipient-message" class="form__floating-label">{{ 'gift_card.recipient.message_label' | t }}</label>
        </div>
      </div>
    </gift-card-recipient>
  {%- endif -%}

  <div class="product-form__payment-container">
    {%- comment -%}
    CUSTOM: If hide_online_price is true, show call-for-quote CTA instead of buy button
    {%- endcomment -%}
    {%- if hide_online_price -%}
      {%- comment -%}Call for quote CTA - device-aware{%- endcomment -%}
      {%- if shop.phone != blank -%}
        {%- comment -%}Mobile: clickable phone link{%- endcomment -%}
        <a href="tel:{{ shop.phone }}" class="product-form__add-button button button--primary hidden-tablet-and-up">
          Call for Quote: {{ shop.phone }}
        </a>

        {%- comment -%}Desktop: styled call-to-action box{%- endcomment -%}
        <div class="product-form__call-quote hidden-phone" style="background: var(--secondary-background, #ffffff); border: 2px solid var(--border-color, #e1e3e4); border-radius: 4px; padding: 1.5rem; text-align: center; margin-bottom: 1rem;">
          <p style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 0.75rem 0; color: var(--text-color, #677279); font-weight: 600;">Call for Quote</p>
          <a href="tel:{{ shop.phone }}" style="font-size: 1.5rem; font-weight: bold; color: var(--accent-color, #00badb); text-decoration: none; display: inline-block; margin: 0;">{{ shop.phone }}</a>
          <p style="font-size: 0.875rem; margin: 0.75rem 0 0 0; color: var(--text-color, #677279);">Contact us for pricing and availability</p>
        </div>
      {%- else -%}
        {%- comment -%}Fallback if no phone number set in Shopify{%- endcomment -%}
        <a href="mailto:{{ shop.email }}" class="product-form__add-button button button--primary">
          Email for Quote
        </a>
      {%- endif -%}
    {%- else -%}
      {%- comment -%}Original buy button logic{%- endcomment -%}
      {%- if product.template_suffix != 'contact' -%}
        {%- if product.selected_or_first_available_variant == nil -%}
          <button type="button" class="product-form__add-button button button--disabled" disabled>{{ 'product.form.unavailable' | t }}</button>
        {%- elsif product.selected_or_first_available_variant.available -%}
          {%- if product.template_suffix == 'pre-order' -%}
            <buy-button class="buy-button">
              <button type="submit" class="product-form__add-button button button--primary">{{ 'product.form.pre_order' | t }}</button>
            </buy-button>
          {%- else -%}
            <buy-button class="buy-button">
              <button type="submit" class="product-form__add-button button button--primary">{{ 'product.form.add_to_cart' | t }}</button>
            </buy-button>
          {%- endif -%}
        {%- else -%}
          <button type="submit" class="product-form__add-button button button--disabled" disabled>{{ 'product.form.sold_out' | t }}</button>
        {%- endif -%}

        {%- if block.settings.show_payment_button and recipient_feature_active == false and product.template_suffix != 'pre-order' -%}
          {{ form | payment_button }}
        {%- endif -%}
      {%- else -%}
        <a href="mailto:{{ shop.email }}" class="button button--primary">{{ 'product.form.contact_us' | t }}</a>
      {%- endif -%}
    {%- endif -%}

    {%- if block.settings.show_payment_button -%}
      {%- unless product.selected_or_first_available_variant.available -%}
        <style>
          #shopify-section-{{ section.id }} .shopify-payment-button {
            display: none;
          }
        </style>
      {%- endunless -%}
    {%- endif -%}
  </div>
</div>
