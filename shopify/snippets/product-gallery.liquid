{%- if product.media.size > 0 -%}
  {%- assign show_thumbnails_if_one_media = true -%}

  <div class="card">
    <div class="card__section card__section--tight">
      <div class="product-gallery {% if show_thumbnails_if_one_media %}product-gallery--with-thumbnails{% endif %}">
        {%- assign selected_media = product.selected_variant.featured_media | default: product.featured_media -%}

        <div class="product-gallery__carousel-wrapper">
          <div class="product-gallery__carousel {% if template != 'product.quick-view' and section.settings.enable_image_zoom %}product-gallery__carousel--zoomable{% endif %}" data-media-count="{{ product.media.size }}" data-initial-media-id="{{ selected_media.id }}">
            {%- for media in product.media -%}
              {%- assign is_media_group = false -%}
              {%- assign is_media_filtered = false -%}
              {%- assign media_alt = media.alt -%}
              {%- assign group_name = '' -%}
              {%- assign group_value = '' -%}

              {%- comment -%}
              Multi-hashtag filtering for format: "Description #Color#Unit of Sale"
              Extracts the first hashtag value as the Color for filtering
              {%- endcomment -%}

              {%- if media.alt contains '#' -%}
                {%- assign is_media_group = true -%}
                {%- assign alt_parts = media.alt | split: '#' -%}

                {%- comment -%} First part before # is the description/alt text {%- endcomment -%}
                {%- if alt_parts.first != blank -%}
                  {%- assign media_alt = alt_parts.first | strip -%}
                {%- else -%}
                  {%- assign media_alt = product.title -%}
                {%- endif -%}

                {%- comment -%} Second part (index 1) is the Color value {%- endcomment -%}
                {%- if alt_parts.size > 1 -%}
                  {%- assign group_name = 'color' -%}
                  {%- assign group_value = alt_parts[1] | strip | downcase -%}

                  {%- comment -%} Check if this image should be filtered based on selected variant {%- endcomment -%}
                  {%- assign selected_color = product.selected_or_first_available_variant.option1 | downcase -%}
                  {%- if group_value != selected_color -%}
                    {%- assign is_media_filtered = true -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}

              <div class="product-gallery__carousel-item {% if media.id == selected_media.id %}is-selected{% endif %} {% if is_media_filtered %}is-filtered{% endif %}" tabindex="-1" data-media-id="{{ media.id }}" data-media-type="{{ media.media_type | escape }}" data-media-alt="{{ media.alt | escape }}" {% if media.media_type == 'external_video' %}data-media-host="{{ media.host | escape }}" data-video-id="{{ media.external_id | escape }}"{% endif %} {% if is_media_group %}data-group-name="{{ group_name | escape }}" data-group-value="{{ group_value | escape }}"{% endif %}>
                {%- case media.media_type -%}
                  {%- when 'image' -%}
                    <div class="product-gallery__size-limiter" style="max-width: {{ media.width }}px">
                      {%- assign data_zoom_url = media | image_url: width: 1800 -%}
                      {%- assign data_zoom_width = 1800 | at_most: media.width -%}

                      <div class="aspect-ratio" style="padding-bottom: {{ 100.0 | divided_by: media.aspect_ratio }}%">
                        {{- media | image_url: width: media.width | image_tag: loading: 'lazy', widths: '400,500,600,700,800,900,1000,1100,1200', class: 'product-gallery__image', data-zoom: data_zoom_url, data-zoom-width: data_zoom_width, alt: media_alt -}}
                      </div>
                    </div>

                  {%- when 'model' -%}
                    <div class="product-gallery__model">
                      <div class="model-wrapper">
                        {{- media | model_viewer_tag: image_size: '1024x', reveal: 'interaction', toggleable: true -}}
                      </div>
                    </div>

                  {%- when 'external_video' -%}
                    <div class="product-gallery__external-video">
                      <div class="video-wrapper">
                        {{- media | external_video_tag: image_size: '1024x', loop: section.settings.enable_video_looping -}}
                      </div>
                    </div>

                  {%- when 'video' -%}
                    <div class="product-gallery__video">
                      <div class="video-wrapper video-wrapper--native" style="padding-bottom: {{ 100.0 | divided_by: media.aspect_ratio }}%">
                        {{- media | video_tag: image_size: '1024x', controls: true -}}
                      </div>
                    </div>
                {%- endcase -%}
              </div>
            {%- endfor -%}
          </div>

          {%- comment -%}Add the "view in your space" button, which allows to show the product in customer's environment (if the device supports it){%- endcomment -%}
          {%- assign first_3d_model = product.media | where: 'media_type', 'model' | first -%}

          {%- if first_3d_model -%}
            <button class="product-gallery__view-in-space button button--full" data-shopify-xr data-shopify-model3d-id="{{ first_3d_model.id }}" data-shopify-model3d-default-id="{{ first_3d_model.id }}" data-shopify-title="{{ product.title | escape }}" data-shopify-xr-hidden>
              {%- render 'icon', icon: 'media-view-in-space' -%} {{- 'product.general.view_in_space' | t -}}
            </button>
          {%- endif -%}

          {%- if template != 'product.quick-view' and section.settings.enable_image_zoom -%}
            <span class="product-gallery__zoom-notice">
              {% render 'icon', icon: 'zoom' %}
              <span class="hidden-pocket">{{ 'product.general.zoom' | t }}</span>
              <span class="hidden-lap-and-up">{{ 'product.general.zoom_mobile' | t }}</span>
            </span>
          {%- endif -%}
        </div>

        {%- if show_thumbnails_if_one_media -%}
          <div class="scroller">
            <div class="scroller__inner">
              <div class="product-gallery__thumbnail-list">
                {%- for media in product.media -%}
                  {%- assign is_media_group = false -%}
                  {%- assign is_media_filtered = false -%}
                  {%- assign media_alt = media.alt -%}
                  {%- assign group_name = '' -%}
                  {%- assign group_value = '' -%}

                  {%- comment -%}
                  Multi-hashtag filtering for format: "Description #Color#Unit of Sale"
                  Extracts the first hashtag value as the Color for filtering
                  {%- endcomment -%}

                  {%- if media.alt contains '#' -%}
                    {%- assign is_media_group = true -%}
                    {%- assign alt_parts = media.alt | split: '#' -%}

                    {%- comment -%} First part before # is the description/alt text {%- endcomment -%}
                    {%- if alt_parts.first != blank -%}
                      {%- assign media_alt = alt_parts.first | strip -%}
                    {%- else -%}
                      {%- assign media_alt = product.title -%}
                    {%- endif -%}

                    {%- comment -%} Second part (index 1) is the Color value {%- endcomment -%}
                    {%- if alt_parts.size > 1 -%}
                      {%- assign group_name = 'color' -%}
                      {%- assign group_value = alt_parts[1] | strip | downcase -%}

                      {%- comment -%} Check if this image should be filtered based on selected variant {%- endcomment -%}
                      {%- assign selected_color = product.selected_or_first_available_variant.option1 | downcase -%}
                      {%- if group_value != selected_color -%}
                        {%- assign is_media_filtered = true -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endif -%}

                  <a href="{{ media | img_url: '1024x' }}" rel="noopener" class="product-gallery__thumbnail {% if media.id == selected_media.id %}is-nav-selected{% endif %} {% if is_media_filtered %}is-filtered{% endif %}" data-media-id="{{ media.id }}" data-media-alt="{{ media.alt | escape }}" {% if is_media_group %}data-group-name="{{ group_name | escape }}" data-group-value="{{ group_value | escape }}"{% endif %}>
                    {%- comment -%}Based on the type of media, we have to add an icon as per Shopify rules{%- endcomment -%}

                    {%- case media.media_type -%}
                      {%- when 'model' -%}
                        <span class="product-gallery__thumbnail-badge">{% render 'icon', icon: 'media-model-badge' %}</span>

                      {%- when 'video' or 'external_video' -%}
                        <span class="product-gallery__thumbnail-badge">{% render 'icon', icon: 'media-video-badge' %}</span>
                    {%- endcase -%}

                    {{- media | image_url: width: media.width | image_tag: loading: 'lazy', sizes: '130px', widths: '130,260,390', alt: media_alt -}}
                  </a>
                {%- endfor -%}
              </div>
            </div>
          </div>
        {%- endif -%}

        {%- if section.settings.enable_image_zoom -%}
          {%- comment -%}This code is used to power the mobile zoom and must not be removed nor altered{%- endcomment -%}
          <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="pswp__bg"></div>
            <div class="pswp__scroll-wrap">
              <div class="pswp__container">
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
                <div class="pswp__item"></div>
              </div>

              <div class="pswp__ui">
                <button class="pswp__button pswp__button--close" aria-label="{{ 'general.accessibility.close' | t }}">
                  {% render 'icon', icon: 'close-2' %}
                </button>

                <div class="pswp__prev-next">
                  <button class="pswp__button pswp__button--arrow--left" aria-label="{{ 'general.accessibility.previous' | t }}">
                    {% render 'icon', icon: 'arrow-left' %}
                  </button>

                  <button class="pswp__button pswp__button--arrow--right" aria-label="{{ 'general.accessibility.next' | t }}">
                    {% render 'icon', icon: 'arrow-right' %}
                  </button>
                </div>

                <div class="pswp__pagination">
                  <span class="pswp__pagination-current"></span> / <span class="pswp__pagination-count"></span>
                </div>
              </div>
            </div>
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>

  {%- comment -%}
  ============================================
  CUSTOM: Multi-Option Image Filtering
  ============================================
  This script extends the Warehouse theme's built-in variant image filtering
  to support multiple hashtag values in alt text.

  Alt text format: "Description #Color#Unit of Sale" (e.g., "#Onyx Natural#Sq Ft")

  The theme's built-in filtering only supports single-option filtering.
  This script intercepts variant changes using CAPTURE PHASE to run BEFORE
  the theme's handler, updates the data-group-value attributes to encode
  multi-option matching, then lets the theme handle filtering and Flickity refresh.
  {%- endcomment -%}

  {%- comment -%} Force hide filtered items with !important to override Flickity {%- endcomment -%}
  <style>
    .product-gallery__carousel-item.is-filtered,
    .product-gallery__thumbnail.is-filtered {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
  </style>

  <script>
  (function() {
    console.log('[MultiFilter] Script initializing...');

    var productSection = document.querySelector('[data-section-type="product"]');
    if (!productSection) {
      console.log('[MultiFilter] ERROR: Product section not found!');
      return;
    }
    console.log('[MultiFilter] Product section found');

    // Listen on DOCUMENT to catch all variant:change events regardless of where the form is
    // Use CAPTURE PHASE to run BEFORE the theme's bubbling listener
    document.addEventListener('variant:change', function(event) {
      console.log('[MultiFilter] CAPTURE: variant:change event received');
      console.log('[MultiFilter] Event target:', event.target.tagName, event.target.id || '(no id)');

      var newVariant = event.detail.variant;
      if (!newVariant) {
        console.log('[MultiFilter] No variant in event');
        return;
      }

      console.log('[MultiFilter] New variant:', newVariant.option1, newVariant.option2, newVariant.option3);

      // Build selected options array (lowercased for comparison)
      var selectedOptions = [];
      for (var i = 1; i <= 3; i++) {
        var optionValue = newVariant['option' + i];
        if (optionValue) {
          selectedOptions.push(optionValue.toLowerCase());
        }
      }
      console.log('[MultiFilter] Selected options:', selectedOptions);

      // Get all carousel items and thumbnails from the product section
      var carouselItems = productSection.querySelectorAll('.product-gallery__carousel-item');
      var thumbnails = productSection.querySelectorAll('.product-gallery__thumbnail');
      console.log('[MultiFilter] Carousel items:', carouselItems.length, 'Thumbnails:', thumbnails.length);

      var matchCount = 0;
      var filterCount = 0;

      carouselItems.forEach(function(item, index) {
        var mediaAlt = item.getAttribute('data-media-alt') || '';
        var thumbnail = thumbnails[index];

        // Skip images without hashtag filtering
        if (mediaAlt.indexOf('#') === -1) return;

        // Parse hashtag values from alt text
        var parts = mediaAlt.split('#');
        var hashtagValues = [];
        for (var j = 1; j < parts.length; j++) {
          var value = parts[j].trim().toLowerCase();
          if (value) hashtagValues.push(value);
        }

        if (hashtagValues.length === 0) return;

        // Check if ALL hashtag values match corresponding selected options
        var allMatch = true;
        for (var k = 0; k < hashtagValues.length && k < selectedOptions.length; k++) {
          if (hashtagValues[k] !== selectedOptions[k]) {
            allMatch = false;
            break;
          }
        }

        // Update data-group-value to trick theme's built-in filter
        if (allMatch) {
          item.setAttribute('data-group-value', selectedOptions[0]);
          if (thumbnail) thumbnail.setAttribute('data-group-value', selectedOptions[0]);
          matchCount++;
        } else {
          item.setAttribute('data-group-value', '__filtered__');
          if (thumbnail) thumbnail.setAttribute('data-group-value', '__filtered__');
          filterCount++;
        }
      });

      console.log('[MultiFilter] Results: matching=' + matchCount + ', filtered=' + filterCount);
    }, true); // CAPTURE PHASE on document

    // Bubbling phase listener - runs AFTER theme, then force visual update
    document.addEventListener('variant:change', function(event) {
      console.log('[MultiFilter] BUBBLE: variant:change (after theme processed)');

      // Check DOM state
      var carouselFiltered = productSection.querySelectorAll('.product-gallery__carousel-item.is-filtered');
      var carouselTotal = productSection.querySelectorAll('.product-gallery__carousel-item');
      var thumbFiltered = productSection.querySelectorAll('.product-gallery__thumbnail.is-filtered');
      var thumbTotal = productSection.querySelectorAll('.product-gallery__thumbnail');

      console.log('[MultiFilter] Carousel: ' + carouselFiltered.length + ' filtered / ' + carouselTotal.length + ' total');
      console.log('[MultiFilter] Thumbnails: ' + thumbFiltered.length + ' filtered / ' + thumbTotal.length + ' total');

      // Force Flickity to refresh after a short delay
      setTimeout(function() {
        var carousel = productSection.querySelector('.product-gallery__carousel');
        if (!carousel) {
          console.log('[MultiFilter] Carousel element not found');
          return;
        }

        // Try to access Flickity instance
        var flickity = null;
        if (typeof Flickity !== 'undefined') {
          flickity = Flickity.data(carousel);
        }

        if (flickity) {
          console.log('[MultiFilter] Flickity found, refreshing...');
          flickity.deactivate();
          flickity.activate();

          // Select first visible cell
          var firstVisible = carousel.querySelector('.product-gallery__carousel-item:not(.is-filtered)');
          if (firstVisible) {
            flickity.selectCell(firstVisible);
          }
          console.log('[MultiFilter] Flickity refreshed');
        } else {
          console.log('[MultiFilter] Flickity not accessible globally');
        }
      }, 50);
    }, false); // BUBBLE PHASE

    console.log('[MultiFilter] Listeners attached to document (capture + bubble)');
  })();
  </script>

{%- endif -%}